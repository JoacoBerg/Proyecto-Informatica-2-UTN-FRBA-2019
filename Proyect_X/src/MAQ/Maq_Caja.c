/*******************************************************************************************************************************//**
 *
 * @file		Maq_Caja.c
 * @brief		Descripcion del modulo
 * @date		3 nov. 2019
 * @author		Ing. Marcelo Trujillo
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include "Maq_Caja.h"

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/**
	\fn  Nombre de la Funcion
	\brief Descripcion
 	\author Ing. Marcelo Trujillo
 	\date 3 nov. 2019
 	\param [in] parametros de entrada
 	\param [out] parametros de salida
	\return tipo y descripcion de retorno
*/

void init_led(uint8_t puerto, uint8_t pin)
{
	SetPinsel(puerto, pin, PINSEL_GPIO);
	SetPinMode(puerto, pin, PINMODE_PULLUP);
	SetPinDir(puerto, pin, PINDIR_OUTPUT);
}


void init_caja()
{
	init_led(PIN_RED);
	init_led(PIN_BLUE);
	init_led(PIN_GREEN);

	SERVO_CERRADO;
}


// FUNCION Maq_Caja: se encarga de supervisar el estado de la caja
//return: exito si tarjeta ID, Boton e iman son correctos
uint8_t Maq_Caja()
{
	static uint8_t estado = RESET;

	switch(estado)
	{
		case RESET:
			RED_OFF;
			GREEN_OFF;
			BLUE_OFF;

			estado = BUSCAR_TARJETA;
			break;

		case BUSCAR_TARJETA:
			if(!Card())
				RED_ON;
			else
			{
				SERVO_ABIERTO;
				RED_OFF;

				estado = BUSCAR_BOTON;
			}
			break;

		case BUSCAR_BOTON:
			if( BOTON )
			{
				SERVO_CERRADO;
				BLUE_OFF;

				estado = BUSCAR_IMAN;
			}
			else
				BLUE_ON;

			break;

		case BUSCAR_IMAN:
			if(! IMAN)
			{
				GREEN_ON;
				return EXITO;
			}
			break;

		default:	estado = RESET;
	}

	return 0;
}

/*******************************************************************************************************************************//**
 *
 * @file		Maq_Follow_the_line.c
 * @brief		Descripcion del modulo
 * @date		15 sep. 2019
 * @author		Ing. Marcelo Trujillo
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include <DR_IR.h>
#include <Maq_FollowTheLine.h>
#include "Tanks.h"

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/


//------------------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------------------------------
//------------------------------MAQUINA DE ESTADOS DE FOLLOW THE LINE---------------------------------------------------------------
//------------------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------------------------------

//Declaracion de estados
#define 	X11X	0
#define 	X10X	1
#define 	X01X	2
#define 	RESET	3
#define 	ALARMA	4


#define		VELOCIDAD_FTL 75


uint8_t Maq_FollowTheLine(void)
{
		static uint8_t cruces = 0;
		static uint8_t estado = RESET;

		switch(estado)
		{
			case X11X:

				if(IR_IZQ_IN == 0 && IR_DER_IN == 1)
				{
					Tank_Right(VELOCIDAD_FTL);
					estado = X01X;

				}
				if(IR_IZQ_IN == 1 && IR_DER_IN == 0)
				{
					Tank_Left(VELOCIDAD_FTL);
					estado = X10X;

				}
				if(IR_IZQ_OUT == 0 && IR_IZQ_IN == 1 && IR_DER_IN == 1 && IR_DER_OUT == 0){
					cruces = 1;
				}
				if(IR_IZQ_OUT == 1 && IR_IZQ_IN == 1 && IR_DER_IN == 1 && IR_DER_OUT == 1 && cruces)	//pregunta por el cruce
				{
					Tank_Brake();
					estado = RESET;
					cruces = 0;
					return EXITO;


				}

				break;

			case X10X:

				if(IR_IZQ_IN == 1 && IR_DER_IN == 1)
				{
					Tank_Forward(VELOCIDAD_FTL);
					estado = X11X;

				}

				break;

			case X01X:

				if(IR_IZQ_IN == 1 && IR_DER_IN == 1)
				{
					Tank_Forward(VELOCIDAD_FTL);
					estado = X11X;

				}

				break;

			case RESET:

				estado = X11X;

				break;

			case ALARMA:
				return FALLO;

				break;

			default: estado = RESET;
		}
		return ENPROCESO;
}

//Funciones asociadas a los eventos

/*
int Cruce(void)
{}
void CruceAdd(void)
{}
*/

//------------------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------------------------------
//------------------------------FIN MAQUINA DE ESTADOS DE FOLLOW THE LINE---------------------------------------------------------------
//------------------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------------------------------


